–°–ë–û–†–ö–ê –ö–û–î–ê –ü–†–û–ï–ö–¢–ê: 
–í–†–ï–ú–Ø: 2025-11-06 12:11:57
====================================================================================================


================================================================================
–§–ê–ô–õ: bot.py
–†–ê–ó–ú–ï–†: 3389 –±–∞–π—Ç
================================================================================

# bot.py
import asyncio
import logging
import os
from aiogram import Bot, Dispatcher
from aiogram.fsm.storage.memory import MemoryStorage

from config import BOT_TOKEN
from handlers.start import router as start_router
from handlers.student_help import router as student_router
from handlers.programming import router as programming_router
from handlers.common import router as common_router
from utils.auto_messages import AutoMessageScheduler
from utils.context import set_bot, set_scheduler
from utils.logger import setup_logger, cleanup_old_logs

import os

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
if not os.getenv('BOT_TOKEN'):
    print("‚ùå BOT_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!")
    print("–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è BOT_TOKEN –ø–µ—Ä–µ–¥–∞–Ω–∞ –≤ –æ–∫—Ä—É–∂–µ–Ω–∏–µ")
    exit(1)

if not os.getenv('ADMIN_ID'):
    print("‚ö†Ô∏è  ADMIN_ID –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω—É –æ—Ç–∫–ª—é—á–µ–Ω—ã")

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–≥–µ—Ä–∞
setup_logger()
cleanup_old_logs()

logger = logging.getLogger(__name__)

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞ –∏ –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∞
bot = Bot(token=BOT_TOKEN)
dp = Dispatcher(storage=MemoryStorage())
auto_message_scheduler = AutoMessageScheduler()
auto_message_scheduler.set_bot(bot)

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã
set_bot(bot)
set_scheduler(auto_message_scheduler)

# –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ä–æ—É—Ç–µ—Ä–æ–≤
dp.include_router(start_router)
dp.include_router(student_router)
dp.include_router(programming_router)
dp.include_router(common_router)


async def main():
    logger.info("üöÄ –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ Lab&Code –≤ Docker...")

    # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å—Ä–µ–¥–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
    logger.info(f"Python version: {os.sys.version}")
    logger.info(f"Running in container: {os.path.exists('/.dockerenv')}")

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∞–¥–º–∏–Ω—É –æ –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞
    from config import ADMIN_ID
    if ADMIN_ID:
        try:
            await bot.send_message(
                ADMIN_ID,
                "üê≥ –ë–æ—Ç Lab&Code –∑–∞–ø—É—â–µ–Ω –≤ Docker –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!",
                parse_mode='Markdown'
            )
            logger.info("‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –∑–∞–ø—É—Å–∫–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –∞–¥–º–∏–Ω—É")
        except Exception as e:
            logger.error(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –∑–∞–ø—É—Å–∫–µ: {e}")

    try:
        await dp.start_polling(bot)
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞: {e}")
        raise
    finally:
        # –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã
        for user_tasks in auto_message_scheduler.scheduled_tasks.values():
            for task in user_tasks:
                task.cancel()
        await bot.session.close()
        logger.info("‚èπ –ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")


if __name__ == "__main__":
    try:
        asyncio.run(main())
    except KeyboardInterrupt:
        logger.info("‚èπ –ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ –∫–æ–º–∞–Ω–¥–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è")
    except Exception as e:
        logger.critical(f"üí• –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}")
        exit(1)


================================================================================
–§–ê–ô–õ: cleanup_logs.py
–†–ê–ó–ú–ï–†: 1355 –±–∞–π—Ç
================================================================================

# cleanup_logs.py
"""
–°–∫—Ä–∏–ø—Ç –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ —Å—Ç–∞—Ä—ã—Ö –ª–æ–≥-—Ñ–∞–π–ª–æ–≤
–ó–∞–ø—É—Å–∫–∞–π—Ç–µ —Ä–∞–∑ –≤ –Ω–µ–¥–µ–ª—é —á–µ—Ä–µ–∑ cron –∏–ª–∏ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞—á
"""

import os
import glob
import time
from datetime import datetime


def cleanup_logs(log_dir="logs", keep_days=30):
    """–û—á–∏—Å—Ç–∫–∞ –ª–æ–≥-—Ñ–∞–π–ª–æ–≤ —Å—Ç–∞—Ä—à–µ keep_days –¥–Ω–µ–π"""

    if not os.path.exists(log_dir):
        print(f"üìÅ –ü–∞–ø–∫–∞ {log_dir} –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç")
        return

    current_time = time.time()
    deleted_count = 0

    # –ò—â–µ–º –≤—Å–µ –ª–æ–≥-—Ñ–∞–π–ª—ã
    for log_file in glob.glob(os.path.join(log_dir, "*.log*")):
        file_time = os.path.getctime(log_file)

        # –ï—Å–ª–∏ —Ñ–∞–π–ª —Å—Ç–∞—Ä—à–µ keep_days –¥–Ω–µ–π
        if file_time < current_time - (keep_days * 86400):
            try:
                os.remove(log_file)
                deleted_count += 1
                print(f"üóëÔ∏è –£–¥–∞–ª–µ–Ω: {log_file}")
            except Exception as e:
                print(f"‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è {log_file}: {e}")

    print(f"‚úÖ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –£–¥–∞–ª–µ–Ω–æ —Ñ–∞–π–ª–æ–≤: {deleted_count}")


if __name__ == "__main__":
    print(f"üïê –ù–∞—á–∞–ª–æ –æ—á–∏—Å—Ç–∫–∏ –ª–æ–≥–æ–≤: {datetime.now()}")
    cleanup_logs()


================================================================================
–§–ê–ô–õ: collector.py
–†–ê–ó–ú–ï–†: 7020 –±–∞–π—Ç
================================================================================

import os
import argparse
from pathlib import Path


class CodeCollector:
    def __init__(self):
        self.default_extensions = {
            'python': ['.py'],
            'web': ['.html', '.css', '.js', '.jsx', '.ts', '.tsx'],
            'java': ['.java'],
            'cpp': ['.cpp', '.c', '.h', '.hpp'],
            'config': ['.json', '.xml', '.yaml', '.yml'],
            'docs': ['.md', '.txt', '.rst']
        }

        self.ignore_dirs = [
            '__pycache__', '.git', 'venv', 'env', 'node_modules',
            '.idea', 'build', 'dist', '.vscode', '__pycache__',
            'target', '.gradle', '.settings', '.venv'
        ]

        self.ignore_files = [
            'package-lock.json', 'yarn.lock', '.DS_Store'
        ]

    def collect_code(self, project_path, output_file, file_types=None, max_file_size=1024 * 1024):
        """
        –°–æ–±–∏—Ä–∞–µ—Ç –∫–æ–¥ –ø—Ä–æ–µ–∫—Ç–∞ –≤ –æ–¥–∏–Ω —Ñ–∞–π–ª

        Args:
            project_path (str): –ü—É—Ç—å –∫ –ø—Ä–æ–µ–∫—Ç—É
            output_file (str): –í—ã—Ö–æ–¥–Ω–æ–π —Ñ–∞–π–ª
            file_types (list): –¢–∏–ø—ã —Ñ–∞–π–ª–æ–≤ –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è
            max_file_size (int): –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ (–≤ –±–∞–π—Ç–∞—Ö)
        """
        if file_types is None:
            file_types = ['python']  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ç–æ–ª—å–∫–æ Python

        # –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –∏–∑ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ç–∏–ø–æ–≤
        extensions = []
        for file_type in file_types:
            if file_type in self.default_extensions:
                extensions.extend(self.default_extensions[file_type])

        project_path = Path(project_path)

        with open(output_file, 'w', encoding='utf-8') as outfile:
            # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
            outfile.write(f"–°–ë–û–†–ö–ê –ö–û–î–ê –ü–†–û–ï–ö–¢–ê: {project_path.name}\n")
            outfile.write(f"–í–†–ï–ú–Ø: {self._get_timestamp()}\n")
            outfile.write("=" * 100 + "\n\n")

            file_count = 0
            total_size = 0

            for file_path in project_path.rglob('*'):
                if file_path.is_file():
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª
                    if self._should_ignore(file_path):
                        continue

                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ
                    if file_path.suffix.lower() not in extensions:
                        continue

                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞
                    try:
                        file_size = file_path.stat().st_size
                        if file_size > max_file_size:
                            print(f"–ü—Ä–æ–ø—É—â–µ–Ω (—Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π): {file_path}")
                            continue
                    except OSError:
                        continue

                    try:
                        # –ß–∏—Ç–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞
                        with open(file_path, 'r', encoding='utf-8') as infile:
                            content = infile.read()

                        # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –≤ –≤—ã—Ö–æ–¥–Ω–æ–π —Ñ–∞–π–ª
                        relative_path = file_path.relative_to(project_path)
                        outfile.write(f"\n{'=' * 80}\n")
                        outfile.write(f"–§–ê–ô–õ: {relative_path}\n")
                        outfile.write(f"–†–ê–ó–ú–ï–†: {file_size} –±–∞–π—Ç\n")
                        outfile.write(f"{'=' * 80}\n\n")
                        outfile.write(content)
                        outfile.write('\n\n')

                        file_count += 1
                        total_size += len(content.encode('utf-8'))

                        print(f"‚úì –û–±—Ä–∞–±–æ—Ç–∞–Ω: {relative_path}")

                    except UnicodeDecodeError:
                        print(f"‚úó –û—à–∏–±–∫–∞ –∫–æ–¥–∏—Ä–æ–≤–∫–∏: {file_path}")
                    except Exception as e:
                        print(f"‚úó –û—à–∏–±–∫–∞: {file_path} - {e}")

            # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            outfile.write(f"\n{'=' * 100}\n")
            outfile.write(f"–°–¢–ê–¢–ò–°–¢–ò–ö–ê:\n")
            outfile.write(f"- –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ —Ñ–∞–π–ª–æ–≤: {file_count}\n")
            outfile.write(f"- –û–±—â–∏–π —Ä–∞–∑–º–µ—Ä –∫–æ–¥–∞: {total_size} –±–∞–π—Ç\n")
            outfile.write(f"- –î–∞—Ç–∞ —Å–±–æ—Ä–∫–∏: {self._get_timestamp()}\n")

    def _should_ignore(self, file_path):
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –Ω—É–∂–Ω–æ –ª–∏ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª/–ø–∞–ø–∫—É"""
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞–ø–∫–∏
        for part in file_path.parts:
            if part in self.ignore_dirs:
                return True

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∞–π–ª—ã
        if file_path.name in self.ignore_files:
            return True

        return False

    def _get_timestamp(self):
        from datetime import datetime
        return datetime.now().strftime("%Y-%m-%d %H:%M:%S")

    def show_available_types(self):
        """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–∏–ø—ã —Ñ–∞–π–ª–æ–≤"""
        print("–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–∏–ø—ã —Ñ–∞–π–ª–æ–≤:")
        for file_type, extensions in self.default_extensions.items():
            print(f"  {file_type}: {', '.join(extensions)}")


def main():
    parser = argparse.ArgumentParser(description='–°–±–æ—Ä–∫–∞ –≤—Å–µ–≥–æ –∫–æ–¥–∞ –ø—Ä–æ–µ–∫—Ç–∞ –≤ –æ–¥–∏–Ω —Ñ–∞–π–ª')
    parser.add_argument('project_path', nargs='?', default='.',
                        help='–ü—É—Ç—å –∫ –ø—Ä–æ–µ–∫—Ç—É (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: —Ç–µ–∫—É—â–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è)')
    parser.add_argument('-o', '--output', default='all_project_code.txt',
                        help='–ò–º—è –≤—ã—Ö–æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞')
    parser.add_argument('-t', '--types', nargs='+',
                        choices=['python', 'web', 'java', 'cpp', 'config', 'docs'],
                        default=['python'],
                        help='–¢–∏–ø—ã —Ñ–∞–π–ª–æ–≤ –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è')
    parser.add_argument('--list-types', action='store_true',
                        help='–ü–æ–∫–∞–∑–∞—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–∏–ø—ã —Ñ–∞–π–ª–æ–≤')

    args = parser.parse_args()

    collector = CodeCollector()

    if args.list_types:
        collector.show_available_types()
        return

    print(f"–ù–∞—á–∏–Ω–∞–µ–º —Å–±–æ—Ä–∫—É –∫–æ–¥–∞...")
    print(f"–ü—Ä–æ–µ–∫—Ç: {args.project_path}")
    print(f"–í—ã—Ö–æ–¥–Ω–æ–π —Ñ–∞–π–ª: {args.output}")
    print(f"–¢–∏–ø—ã —Ñ–∞–π–ª–æ–≤: {', '.join(args.types)}")
    print("-" * 50)

    collector.collect_code(args.project_path, args.output, args.types)

    print("-" * 50)
    print(f"–°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ {args.output}")


if __name__ == "__main__":
    main()


================================================================================
–§–ê–ô–õ: config.py
–†–ê–ó–ú–ï–†: 928 –±–∞–π—Ç
================================================================================

import os
from dotenv import load_dotenv

load_dotenv()

BOT_TOKEN = os.getenv("BOT_TOKEN")
ADMIN_ID = os.getenv("ADMIN_ID")

if not BOT_TOKEN:
    raise ValueError("BOT_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ .env —Ñ–∞–π–ª–µ")

# VK –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
VK_GROUP_TOKEN = os.getenv("VK_GROUP_TOKEN")
VK_GROUP_ID = os.getenv("VK_GROUP_ID")
VK_ADMIN_ID = os.getenv("VK_ADMIN_ID")

# –ü—Ä–∏–≤–µ–¥–µ–Ω–∏–µ —Ç–∏–ø–æ–≤
if VK_GROUP_ID:
    try:
        VK_GROUP_ID = int(VK_GROUP_ID)
    except (ValueError, TypeError):
        print("‚ùå VK_GROUP_ID –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º")
        VK_GROUP_ID = None

if VK_ADMIN_ID:
    try:
        VK_ADMIN_ID = int(VK_ADMIN_ID)
    except (ValueError, TypeError):
        print("‚ùå VK_ADMIN_ID –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º")
        VK_ADMIN_ID = None

if not VK_GROUP_TOKEN:
    print("‚ö†Ô∏è  VK_GROUP_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω. VK –±–æ—Ç –æ—Ç–∫–ª—é—á–µ–Ω")


================================================================================
–§–ê–ô–õ: memory.py
–†–ê–ó–ú–ï–†: 1071 –±–∞–π—Ç
================================================================================

#!/usr/bin/env python3
# monitor.py
import psutil
import logging
import os
from datetime import datetime


def check_bot_status():
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –±–æ—Ç–∞"""
    bot_running = False
    for proc in psutil.process_iter(['pid', 'name', 'cmdline']):
        try:
            if proc.info['cmdline'] and 'run.py' in ' '.join(proc.info['cmdline']):
                bot_running = True
                print(f"‚úÖ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω (PID: {proc.info['pid']})")
                break
        except (psutil.NoSuchProcess, psutil.AccessDenied):
            pass

    if not bot_running:
        print("‚ùå –ë–æ—Ç –Ω–µ –∑–∞–ø—É—â–µ–Ω")

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–∞–º—è—Ç–∏
    memory = psutil.virtual_memory()
    print(f"üíæ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏: {memory.percent}%")

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∏—Å–∫–∞
    disk = psutil.disk_usage('/')
    print(f"üíø –°–≤–æ–±–æ–¥–Ω–æ –Ω–∞ –¥–∏—Å–∫–µ: {disk.free // (1024 ** 3)}GB")


if __name__ == "__main__":
    check_bot_status()


================================================================================
–§–ê–ô–õ: run.py
–†–ê–ó–ú–ï–†: 2084 –±–∞–π—Ç
================================================================================

# run.py
import asyncio
import logging
import threading
from bot import main as telegram_main
from vk_bot import VKBot
from utils.logger import setup_logger
from config import VK_GROUP_TOKEN, VK_GROUP_ID


async def run_telegram_bot():
    """–ó–∞–ø—É—Å–∫ Telegram –±–æ—Ç–∞"""
    try:
        await telegram_main()
    except Exception as e:
        logging.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ Telegram –±–æ—Ç–µ: {e}")


def run_vk_bot():
    """–ó–∞–ø—É—Å–∫ VK –±–æ—Ç–∞ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ"""
    try:
        logging.info("üîÑ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è VK –±–æ—Ç–∞...")
        vk_bot = VKBot()
        logging.info("‚úÖ VK –±–æ—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω, –∑–∞–ø—É—Å–∫–∞–µ–º...")
        vk_bot.run()
    except Exception as e:
        logging.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ VK –±–æ—Ç–µ: {e}", exc_info=True)


async def main():
    """–ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞"""
    setup_logger()
    logger = logging.getLogger(__name__)

    logger.info("üöÄ –ó–∞–ø—É—Å–∫ –º—É–ª—å—Ç–∏-–ø–ª–∞—Ç—Ñ–æ—Ä–º–µ–Ω–Ω–æ–≥–æ –±–æ—Ç–∞ Lab&Code...")

    # –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
    logger.info(f"VK_GROUP_TOKEN: {'‚úÖ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω' if VK_GROUP_TOKEN else '‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'}")
    logger.info(f"VK_GROUP_ID: {VK_GROUP_ID}")

    # –ó–∞–ø—É—Å–∫–∞–µ–º VK –±–æ—Ç–∞ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω)
    if VK_GROUP_TOKEN and VK_GROUP_ID:
        logger.info("‚úÖ –ó–∞–ø—É—Å–∫ VK –±–æ—Ç–∞ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ...")
        vk_thread = threading.Thread(target=run_vk_bot, daemon=True)
        vk_thread.start()
        logger.info(f"‚úÖ VK –ø–æ—Ç–æ–∫ –∑–∞–ø—É—â–µ–Ω. ID: {vk_thread.ident}, Alive: {vk_thread.is_alive()}")
    else:
        logger.info("‚ùå VK –±–æ—Ç –æ—Ç–∫–ª—é—á–µ–Ω - –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏")

    # –ó–∞–ø—É—Å–∫–∞–µ–º Telegram –±–æ—Ç–∞ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –ø–æ—Ç–æ–∫–µ
    logger.info("‚úÖ –ó–∞–ø—É—Å–∫ Telegram –±–æ—Ç–∞...")
    await run_telegram_bot()


if __name__ == "__main__":
    asyncio.run(main())


================================================================================
–§–ê–ô–õ: test.py
–†–ê–ó–ú–ï–†: 1706 –±–∞–π—Ç
================================================================================

# test_vk_fixed.py
import vk_api
import os
from dotenv import load_dotenv

load_dotenv()

VK_GROUP_TOKEN = os.getenv("VK_GROUP_TOKEN")
VK_GROUP_ID = os.getenv("VK_GROUP_ID")
VK_ADMIN_ID = os.getenv("VK_ADMIN_ID")

print("=== –¢–µ—Å—Ç VK API ===")
print(f"VK_GROUP_TOKEN: {VK_GROUP_TOKEN[:20]}..." if VK_GROUP_TOKEN else "‚ùå VK_GROUP_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
print(f"VK_GROUP_ID: {VK_GROUP_ID}")
print(f"VK_ADMIN_ID: {VK_ADMIN_ID}")

if VK_GROUP_TOKEN and VK_GROUP_ID:
    try:
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è VK API
        vk_session = vk_api.VkApi(token=VK_GROUP_TOKEN)
        vk = vk_session.get_api()

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –≥—Ä—É–ø–ø–µ (—Ä–∞–±–æ—Ç–∞—é—â–∏–π –º–µ—Ç–æ–¥)
        group_info = vk.groups.getById(group_id=VK_GROUP_ID)
        print(f"‚úÖ –ì—Ä—É–ø–ø–∞ –Ω–∞–π–¥–µ–Ω–∞: {group_info[0]['name']}")

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ Long Poll –Ω–∞—Å—Ç—Ä–æ–µ–∫
        print("‚úÖ Long Poll API –¥–æ—Å—Ç—É–ø–µ–Ω")

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è (–∏—Å–ø–æ–ª—å–∑—É–µ–º random_id)
        if VK_ADMIN_ID:
            result = vk.messages.send(
                user_id=int(VK_ADMIN_ID),
                message="‚úÖ –¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç VK –±–æ—Ç–∞",
                random_id=vk_api.utils.get_random_id()
            )
            print(f"‚úÖ –¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ, ID: {result}")

    except vk_api.exceptions.ApiError as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ VK API: {e}")
    except Exception as e:
        print(f"‚ùå –û–±—â–∞—è –æ—à–∏–±–∫–∞: {e}")
else:
    print("‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ç–µ—Å—Ç–∞")


================================================================================
–§–ê–ô–õ: vk_bot.py
–†–ê–ó–ú–ï–†: 15727 –±–∞–π—Ç
================================================================================

# vk_bot.py
import vk_api
from vk_api.bot_longpoll import VkBotLongPoll, VkBotEventType
from vk_api.utils import get_random_id
from vk_api.keyboard import VkKeyboard, VkKeyboardColor
import logging
import json
from datetime import datetime

from config import VK_GROUP_TOKEN, VK_GROUP_ID, VK_ADMIN_ID
from utils.auto_messages import AutoMessageScheduler
from utils.notifications import notify_admin_vk

logger = logging.getLogger(__name__)


class VKBot:
    def __init__(self):
        try:
            logger.info("üîÑ –°–æ–∑–¥–∞–Ω–∏–µ VK —Å–µ—Å—Å–∏–∏...")
            self.vk_session = vk_api.VkApi(token=VK_GROUP_TOKEN)
            logger.info("üîÑ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è LongPoll...")
            self.longpoll = VkBotLongPoll(self.vk_session, int(VK_GROUP_ID))
            logger.info("üîÑ –ü–æ–ª—É—á–µ–Ω–∏–µ VK API...")
            self.vk = self.vk_session.get_api()
            self.user_states = {}
            self.user_data = {}
            self.auto_message_scheduler = AutoMessageScheduler()
            logger.info("‚úÖ VK –±–æ—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ VK –±–æ—Ç–∞: {e}", exc_info=True)
            raise

    def get_keyboard(self, keyboard_type="main_menu"):
        """–°–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä –¥–ª—è VK"""
        keyboard = VkKeyboard(one_time=True)

        if keyboard_type == "main_menu":
            keyboard.add_button("üéì –ü–æ–º–æ—â—å —Å—Ç—É–¥–µ–Ω—Ç–∞–º", color=VkKeyboardColor.PRIMARY)
            keyboard.add_line()
            keyboard.add_button("üíª –û–±—É—á–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—é", color=VkKeyboardColor.SECONDARY)

        elif keyboard_type == "student_help":
            keyboard.add_button("üìù –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω—ã–µ", color=VkKeyboardColor.PRIMARY)
            keyboard.add_button("üìä –ö—É—Ä—Å–æ–≤—ã–µ", color=VkKeyboardColor.PRIMARY)
            keyboard.add_line()
            keyboard.add_button("üéì –î–∏–ø–ª–æ–º–Ω—ã–µ", color=VkKeyboardColor.PRIMARY)
            keyboard.add_button("‚ùî –î—Ä—É–≥–æ–µ", color=VkKeyboardColor.SECONDARY)
            keyboard.add_line()
            keyboard.add_button("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", color=VkKeyboardColor.NEGATIVE)

        elif keyboard_type == "programming":
            keyboard.add_button("C++", color=VkKeyboardColor.PRIMARY)
            keyboard.add_button("Python", color=VkKeyboardColor.PRIMARY)
            keyboard.add_line()
            keyboard.add_button("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", color=VkKeyboardColor.NEGATIVE)

        elif keyboard_type == "format":
            keyboard.add_button("üë§ –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ", color=VkKeyboardColor.PRIMARY)
            keyboard.add_button("üë• –í –≥—Ä—É–ø–ø–µ", color=VkKeyboardColor.PRIMARY)
            keyboard.add_line()
            keyboard.add_button("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", color=VkKeyboardColor.NEGATIVE)

        elif keyboard_type == "back_only":
            keyboard.add_button("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", color=VkKeyboardColor.NEGATIVE)

        return keyboard.get_keyboard()

    def send_message(self, user_id, message, keyboard=None):
        """–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é"""
        try:
            params = {
                'user_id': user_id,
                'message': message,
                'random_id': get_random_id(),
            }
            if keyboard:
                params['keyboard'] = keyboard

            self.vk.messages.send(**params)
            logger.info(f"‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}")
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")

    def handle_start(self, user_id):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã —Å—Ç–∞—Ä—Ç"""
        welcome_message = (
            "üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Lab&Code!\n\n"
            "–Ø –ø–æ–º–æ–≥—É –≤–∞–º:\n"
            "‚Ä¢ üéì –° —É—á–µ–±–Ω—ã–º–∏ —Ä–∞–±–æ—Ç–∞–º–∏ (–ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω—ã–µ, –∫—É—Ä—Å–æ–≤—ã–µ, –¥–∏–ø–ª–æ–º–Ω—ã–µ)\n"
            "‚Ä¢ üíª –û—Å–≤–æ–∏—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ (C++, Python)\n\n"
            "–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:"
        )

        self.user_states[user_id] = "main_menu"
        self.send_message(user_id, welcome_message, self.get_keyboard("main_menu"))

    def handle_student_help(self, user_id):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–∞–∑–¥–µ–ª–∞ –ø–æ–º–æ—â–∏ —Å—Ç—É–¥–µ–Ω—Ç–∞–º"""
        message = (
            "üéì –ü–æ–º–æ—â—å —Å—Ç—É–¥–µ–Ω—Ç–∞–º\n\n"
            "–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —Ä–∞–±–æ—Ç—ã:\n"
            "‚Ä¢ üìù –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω—ã–µ —Ä–∞–±–æ—Ç—ã\n"
            "‚Ä¢ üìä –ö—É—Ä—Å–æ–≤—ã–µ —Ä–∞–±–æ—Ç—ã\n"
            "‚Ä¢ üéì –î–∏–ø–ª–æ–º–Ω—ã–µ —Ä–∞–±–æ—Ç—ã\n"
            "‚Ä¢ ‚ùî –î—Ä—É–≥–∏–µ —É—á–µ–±–Ω—ã–µ —Ä–∞–±–æ—Ç—ã"
        )

        self.user_states[user_id] = "student_help"
        self.user_data[user_id] = {"category": "student_help"}
        self.send_message(user_id, message, self.get_keyboard("student_help"))

    def handle_programming_help(self, user_id):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–∞–∑–¥–µ–ª–∞ –æ–±—É—á–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—é"""
        message = (
            "üíª –û–±—É—á–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—é\n\n"
            "–í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è:\n"
            "‚Ä¢ C++ - –¥–ª—è —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è\n"
            "‚Ä¢ Python - –¥–ª—è –≤–µ–±-—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∏ –∞–Ω–∞–ª–∏–∑–∞ –¥–∞–Ω–Ω—ã—Ö"
        )

        self.user_states[user_id] = "programming_language"
        self.user_data[user_id] = {"category": "programming"}
        self.send_message(user_id, message, self.get_keyboard("programming"))

    def handle_work_type(self, user_id, work_type):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ —Ä–∞–±–æ—Ç—ã"""
        work_types = {
            "–ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω—ã–µ": "üìù –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω—ã–µ —Ä–∞–±–æ—Ç—ã",
            "–∫—É—Ä—Å–æ–≤—ã–µ": "üìä –ö—É—Ä—Å–æ–≤—ã–µ —Ä–∞–±–æ—Ç—ã",
            "–¥–∏–ø–ª–æ–º–Ω—ã–µ": "üéì –î–∏–ø–ª–æ–º–Ω—ã–µ —Ä–∞–±–æ—Ç—ã",
            "–¥—Ä—É–≥–æ–µ": "‚ùî –î—Ä—É–≥–∏–µ —É—á–µ–±–Ω—ã–µ —Ä–∞–±–æ—Ç—ã"
        }

        message = (
            f"{work_types[work_type]}\n\n"
            "üìû –î–ª—è –æ–±—Å—É–∂–¥–µ–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π –∏ —Ä–∞—Å—á–µ—Ç–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏, "
            "–ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à –∫–æ–Ω—Ç–∞–∫—Ç (—Ç–µ–ª–µgram, email –∏–ª–∏ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞):"
        )

        self.user_states[user_id] = "waiting_contact"
        self.user_data[user_id]["work_type"] = work_type
        self.send_message(user_id, message, self.get_keyboard("back_only"))

    def handle_language_choice(self, user_id, language):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —è–∑—ã–∫–∞ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è"""
        languages = {
            "c++": "C++",
            "python": "Python"
        }

        message = (
            f"üíª {languages[language]}\n\n"
            "–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ä–º–∞—Ç –æ–±—É—á–µ–Ω–∏—è:\n"
            "‚Ä¢ üë§ –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ - –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –∑–∞–Ω—è—Ç–∏—è\n"
            "‚Ä¢ üë• –í –≥—Ä—É–ø–ø–µ - –∑–∞–Ω—è—Ç–∏—è –≤ –º–∏–Ω–∏-–≥—Ä—É–ø–ø–∞—Ö"
        )

        self.user_states[user_id] = "programming_format"
        self.user_data[user_id]["language"] = language
        self.send_message(user_id, message, self.get_keyboard("format"))

    def handle_format_choice(self, user_id, format_type):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –æ–±—É—á–µ–Ω–∏—è"""
        message = (
            f"üë§ {format_type.capitalize()}\n\n"
            "üìû –î–ª—è –æ–±—Å—É–∂–¥–µ–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π –∏ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∑–∞–Ω—è—Ç–∏–π, "
            "–ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à –∫–æ–Ω—Ç–∞–∫—Ç (telegram, email –∏–ª–∏ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞):"
        )

        self.user_states[user_id] = "waiting_contact"
        self.user_data[user_id]["format"] = format_type
        self.send_message(user_id, message, self.get_keyboard("back_only"))

    def handle_back(self, user_id):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –Ω–∞–∑–∞–¥"""
        current_state = self.user_states.get(user_id, "main_menu")

        if current_state == "student_help":
            self.handle_start(user_id)
        elif current_state == "programming_language":
            self.handle_start(user_id)
        elif current_state == "programming_format":
            self.handle_programming_help(user_id)
        elif current_state == "waiting_contact":
            if self.user_data.get(user_id, {}).get("category") == "student_help":
                self.handle_student_help(user_id)
            else:
                self.handle_programming_help(user_id)
        else:
            self.handle_start(user_id)

    def handle_contact_info(self, user_id, contact_info):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–Ω—Ç–∞–∫—Ç–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏"""
        user_data = self.user_data.get(user_id, {})

        # –§–æ—Ä–º–∏—Ä—É–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¥–ª—è –∞–¥–º–∏–Ω–∞
        notification = f"üìû –ù–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è VK ID: {user_id}\n"

        if user_data.get("category") == "student_help":
            work_type = user_data.get("work_type", "–Ω–µ —É–∫–∞–∑–∞–Ω")
            notification += f"üéì –¢–∏–ø —Ä–∞–±–æ—Ç—ã: {work_type}\n"
        else:
            language = user_data.get("language", "–Ω–µ —É–∫–∞–∑–∞–Ω")
            format_type = user_data.get("format", "–Ω–µ —É–∫–∞–∑–∞–Ω")
            notification += f"üíª –Ø–∑—ã–∫: {language}\n"
            notification += f"üë§ –§–æ—Ä–º–∞—Ç: {format_type}\n"

        notification += f"üì± –ö–æ–Ω—Ç–∞–∫—Ç: {contact_info}\n"
        notification += f"‚è∞ –í—Ä–µ–º—è: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}"

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω—É - –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –í–´–ó–û–í
        try:
            from utils.notifications import notify_admin_vk
            notify_admin_vk(user_data, contact_info, user_id)
            logger.info(f"‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –∞–¥–º–∏–Ω—É –æ –∫–æ–Ω—Ç–∞–∫—Ç–µ –æ—Ç {user_id}")
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω—É: {e}")

        # –ë–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        thank_message = (
            "‚úÖ –°–ø–∞—Å–∏–±–æ! –í–∞—à–∞ –∑–∞—è–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞.\n\n"
            "üìû –ú—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π.\n\n"
            "–ï—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å —Å—Ä–æ—á–Ω—ã–π –≤–æ–ø—Ä–æ—Å, –Ω–∞–ø–∏—à–∏—Ç–µ –Ω–∞–º –Ω–∞–ø—Ä—è–º—É—é."
        )

        self.user_states[user_id] = "main_menu"
        self.send_message(user_id, thank_message, self.get_keyboard("main_menu"))

    def run(self):
        """–ó–∞–ø—É—Å–∫ VK –±–æ—Ç–∞"""
        logger.info("üöÄ VK –±–æ—Ç –∑–∞–ø—É—â–µ–Ω, –æ–∂–∏–¥–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è...")

        try:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
            group_info = self.vk.groups.getById(group_id=int(VK_GROUP_ID))
            logger.info(f"‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –≥—Ä—É–ø–ø–µ: {group_info[0]['name']}")

            for event in self.longpoll.listen():
                if event.type == VkBotEventType.MESSAGE_NEW and not event.object.message.get('from_id') < 0:
                    user_id = event.object.message['from_id']
                    text = event.object.message['text'].lower().strip()

                    logger.info(f"üì® VK —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç {user_id}: {text}")

                    current_state = self.user_states.get(user_id, "main_menu")

                    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥
                    if text in ['/start', 'start', '–Ω–∞—á–∞—Ç—å', '—Å—Ç–∞—Ä—Ç', '–ø—Ä–∏–≤–µ—Ç']:
                        self.handle_start(user_id)

                    # –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
                    elif current_state == "main_menu":
                        if "–ø–æ–º–æ—â—å —Å—Ç—É–¥–µ–Ω—Ç–∞–º" in text or "üéì" in text:
                            self.handle_student_help(user_id)
                        elif "–æ–±—É—á–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—é" in text or "üíª" in text:
                            self.handle_programming_help(user_id)
                        else:
                            self.handle_start(user_id)

                    # –ü–æ–º–æ—â—å —Å—Ç—É–¥–µ–Ω—Ç–∞–º
                    elif current_state == "student_help":
                        if "–ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω—ã–µ" in text or "üìù" in text:
                            self.handle_work_type(user_id, "–ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω—ã–µ")
                        elif "–∫—É—Ä—Å–æ–≤—ã–µ" in text or "üìä" in text:
                            self.handle_work_type(user_id, "–∫—É—Ä—Å–æ–≤—ã–µ")
                        elif "–¥–∏–ø–ª–æ–º–Ω—ã–µ" in text or "üéì" in text:
                            self.handle_work_type(user_id, "–¥–∏–ø–ª–æ–º–Ω—ã–µ")
                        elif "–¥—Ä—É–≥–æ–µ" in text or "‚ùî" in text:
                            self.handle_work_type(user_id, "–¥—Ä—É–≥–æ–µ")
                        elif "–Ω–∞–∑–∞–¥" in text or "‚¨ÖÔ∏è" in text:
                            self.handle_back(user_id)
                        else:
                            self.handle_student_help(user_id)

                    # –í—ã–±–æ—Ä —è–∑—ã–∫–∞ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è
                    elif current_state == "programming_language":
                        if "c++" in text:
                            self.handle_language_choice(user_id, "c++")
                        elif "python" in text:
                            self.handle_language_choice(user_id, "python")
                        elif "–Ω–∞–∑–∞–¥" in text or "‚¨ÖÔ∏è" in text:
                            self.handle_back(user_id)
                        else:
                            self.handle_programming_help(user_id)

                    # –í—ã–±–æ—Ä —Ñ–æ—Ä–º–∞—Ç–∞ –æ–±—É—á–µ–Ω–∏—è
                    elif current_state == "programming_format":
                        if "–∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ" in text or "üë§" in text:
                            self.handle_format_choice(user_id, "–∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ")
                        elif "–≤ –≥—Ä—É–ø–ø–µ" in text or "üë•" in text:
                            self.handle_format_choice(user_id, "–≤ –≥—Ä—É–ø–ø–µ")
                        elif "–Ω–∞–∑–∞–¥" in text or "‚¨ÖÔ∏è" in text:
                            self.handle_programming_help(user_id)
                        else:
                            self.send_message(user_id, "–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ä–º–∞—Ç –∑–∞–Ω—è—Ç–∏–π:", self.get_keyboard("format"))

                    # –û–∂–∏–¥–∞–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç–∞
                    elif current_state == "waiting_contact":
                        self.handle_contact_info(user_id, text)

                    # –í–æ–∑–≤—Ä–∞—Ç –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
                    elif "–≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é" in text or "üè†" in text:
                        self.handle_start(user_id)

                    # –õ—é–±–æ–µ –¥—Ä—É–≥–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                    else:
                        self.handle_start(user_id)

        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ VK –±–æ—Ç–µ: {e}", exc_info=True)


================================================================================
–§–ê–ô–õ: handlers\common.py
–†–ê–ó–ú–ï–†: 695 –±–∞–π—Ç
================================================================================

from aiogram import Router
from aiogram.types import Message
from aiogram.fsm.context import FSMContext
from keyboards.inline import main_menu_kb

router = Router()


@router.message()
async def handle_any_message(message: Message, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –ª—é–±—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –≤–Ω–µ —Å–æ—Å—Ç–æ—è–Ω–∏–π"""
    current_state = await state.get_state()

    if current_state is None:
        # –ï—Å–ª–∏ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è, –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –Ω–∞—á–∞—Ç—å
        await message.answer(
            "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –Ω–∏–∂–µ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏:",
            reply_markup=main_menu_kb()
        )


================================================================================
–§–ê–ô–õ: handlers\programming.py
–†–ê–ó–ú–ï–†: 3791 –±–∞–π—Ç
================================================================================

from aiogram import Router, F
from aiogram.types import CallbackQuery, Message
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup
from datetime import datetime
import logging
from keyboards.inline import language_kb, format_kb, main_menu_kb, back_kb, main_menu_button_kb
from utils.notifications import notify_admin
from utils.context import context

router = Router()
logger = logging.getLogger('app')  # –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞—à –∫–∞—Å—Ç–æ–º–Ω—ã–π –ª–æ–≥–≥–µ—Ä


class ProgrammingStates(StatesGroup):
    waiting_language = State()
    waiting_format = State()
    waiting_contact = State()


@router.callback_query(F.data == "programming_help")
async def programming_help_start(callback: CallbackQuery, state: FSMContext):
    await callback.message.answer(
        "–ö–∞–∫–æ–π —è–∑—ã–∫ —Ö–æ—Ç–∏—Ç–µ –∏–∑—É—á–∞—Ç—å?",
        reply_markup=language_kb()
    )
    await state.set_state(ProgrammingStates.waiting_language)
    await callback.answer()


@router.callback_query(ProgrammingStates.waiting_language, F.data.startswith("lang_"))
async def language_selected(callback: CallbackQuery, state: FSMContext):
    language = "C++" if callback.data == "lang_cpp" else "Python"

    await state.update_data(
        category="programming",
        language=language,
        username=callback.from_user.username,
        user_id=callback.from_user.id,
        timestamp=datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    )

    await callback.message.answer(
        "–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ä–º–∞—Ç –∑–∞–Ω—è—Ç–∏–π:",
        reply_markup=format_kb()
    )

    await state.set_state(ProgrammingStates.waiting_format)
    await callback.answer()


@router.callback_query(ProgrammingStates.waiting_format, F.data.startswith("format_"))
async def format_selected(callback: CallbackQuery, state: FSMContext):
    format_type = "–∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ" if callback.data == "format_individual" else "–≤ –≥—Ä—É–ø–ø–µ"

    await state.update_data(format=format_type)

    await callback.message.answer(
        "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Å—Ç–∞–≤—å—Ç–µ —Å–≤–æ–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∏–ª–∏ @–Ω–∏–∫ –≤ Telegram –¥–ª—è —Å–≤—è–∑–∏.",
        reply_markup=back_kb("programming_help")
    )

    await state.set_state(ProgrammingStates.waiting_contact)
    await callback.answer()


@router.message(ProgrammingStates.waiting_contact)
async def process_programming_contact(message: Message, state: FSMContext):
    contact_info = message.text
    user_data = await state.get_data()

    # –õ–æ–≥–∏—Ä—É–µ–º –≤ —Ç–æ–º –∂–µ —Ñ–æ—Ä–º–∞—Ç–µ —á—Ç–æ –∏ aiogram
    logger.info(f"üìã –ù–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –Ω–∞ –æ–±—É—á–µ–Ω–∏–µ:\n"
                f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: @{user_data.get('username')} (ID: {user_data.get('user_id')})\n"
                f"üíª –Ø–∑—ã–∫: {user_data.get('language')}\n"
                f"üìö –§–æ—Ä–º–∞—Ç: {user_data.get('format')}\n"
                f"üìû –ö–æ–Ω—Ç–∞–∫—Ç: {contact_info}\n"
                f"{'=' * 50}")

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω—É —á–µ—Ä–µ–∑ context
    await notify_admin(context.bot, user_data, contact_info)

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –° –ö–ù–û–ü–ö–û–ô
    await message.answer(
        "‚úÖ –°–ø–∞—Å–∏–±–æ! –ú—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –≤ —Ç–µ—á–µ–Ω–∏–µ 15 –º–∏–Ω—É—Ç.\n\n"
        "üéÅ –ü–æ–∫–∞ –∂–¥—ë—Ç–µ, –º–æ–∂–µ—Ç–µ —Å–∫–∞—á–∞—Ç—å –±–æ–Ω—É—Å: [—Å—Å—ã–ª–∫–∞ –Ω–∞ PDF]",
        reply_markup=main_menu_button_kb()
    )

    # –ü–ª–∞–Ω–∏—Ä—É–µ–º –∞–≤—Ç–æ—Å–æ–æ–±—â–µ–Ω–∏—è —á–µ—Ä–µ–∑ context
    await context.auto_message_scheduler.schedule_auto_messages(message.from_user.id)

    await state.clear()


================================================================================
–§–ê–ô–õ: handlers\start.py
–†–ê–ó–ú–ï–†: 963 –±–∞–π—Ç
================================================================================

from aiogram import Router, F
from aiogram.types import Message, CallbackQuery
from aiogram.filters import CommandStart
from keyboards.inline import main_menu_kb

router = Router()


@router.message(CommandStart())
async def cmd_start(message: Message):
    welcome_text = """
üëã –ü—Ä–∏–≤–µ—Ç! –≠—Ç–æ Lab&Code.

–ú—ã –ø–æ–º–æ–≥–∞–µ–º:
üìö –°—Ç—É–¥–µ–Ω—Ç–∞–º ‚Äî —Å –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω—ã–º–∏, –∫—É—Ä—Å–æ–≤—ã–º–∏, –¥–∏–ø–ª–æ–º–∞–º–∏
üíª –í—Å–µ–º, –∫—Ç–æ —Ö–æ—á–µ—Ç –æ—Å–≤–æ–∏—Ç—å C++ –∏–ª–∏ Python

–ß—Ç–æ –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç?
    """

    await message.answer(welcome_text, reply_markup=main_menu_kb())


@router.callback_query(F.data == "main_menu")
async def back_to_main(callback: CallbackQuery):
    welcome_text = """
üëã –° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º –≤ Lab&Code!

–ß—Ç–æ –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç?
    """

    await callback.message.answer(welcome_text, reply_markup=main_menu_kb())
    await callback.answer()


================================================================================
–§–ê–ô–õ: handlers\student_help.py
–†–ê–ó–ú–ï–†: 3067 –±–∞–π—Ç
================================================================================

from aiogram import Router, F
from aiogram.types import CallbackQuery, Message
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup
from datetime import datetime
import logging
from keyboards.inline import student_help_kb, main_menu_kb, back_kb, main_menu_button_kb
from utils.notifications import notify_admin
from utils.context import context

router = Router()
logger = logging.getLogger('app')  # –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞—à –∫–∞—Å—Ç–æ–º–Ω—ã–π –ª–æ–≥–≥–µ—Ä


class StudentStates(StatesGroup):
    waiting_contact = State()


@router.callback_query(F.data == "student_help")
async def student_help_start(callback: CallbackQuery):
    await callback.message.answer(
        "–ö–∞–∫–∏–µ —Ä–∞–±–æ—Ç—ã –Ω—É–∂–Ω—ã?",
        reply_markup=student_help_kb()
    )
    await callback.answer()


@router.callback_query(F.data.startswith("work_"))
async def student_work_selected(callback: CallbackQuery, state: FSMContext):
    work_types = {
        "work_labs": "–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω—ã–µ",
        "work_coursework": "–ö—É—Ä—Å–æ–≤—ã–µ",
        "work_diploma": "–î–∏–ø–ª–æ–º–Ω—ã–µ",
        "work_other": "–î—Ä—É–≥–æ–µ"
    }

    work_type = work_types.get(callback.data, "–î—Ä—É–≥–æ–µ")

    await state.update_data(
        category="student_help",
        work_type=work_type,
        username=callback.from_user.username,
        user_id=callback.from_user.id,
        timestamp=datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    )

    await callback.message.answer(
        "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Å—Ç–∞–≤—å—Ç–µ —Å–≤–æ–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∏–ª–∏ @–Ω–∏–∫ –≤ Telegram –¥–ª—è —Å–≤—è–∑–∏.",
        reply_markup=back_kb("student_help")
    )

    await state.set_state(StudentStates.waiting_contact)
    await callback.answer()


@router.message(StudentStates.waiting_contact)
async def process_student_contact(message: Message, state: FSMContext):
    contact_info = message.text
    user_data = await state.get_data()

    # –õ–æ–≥–∏—Ä—É–µ–º –≤ —Ç–æ–º –∂–µ —Ñ–æ—Ä–º–∞—Ç–µ —á—Ç–æ –∏ aiogram
    logger.info(f"üìã –ù–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –æ—Ç —Å—Ç—É–¥–µ–Ω—Ç–∞:\n"
                f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: @{user_data.get('username')} (ID: {user_data.get('user_id')})\n"
                f"üìù –¢–∏–ø —Ä–∞–±–æ—Ç—ã: {user_data.get('work_type')}\n"
                f"üìû –ö–æ–Ω—Ç–∞–∫—Ç: {contact_info}\n"
                f"{'=' * 50}")

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω—É —á–µ—Ä–µ–∑ context
    await notify_admin(context.bot, user_data, contact_info)

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –° –ö–ù–û–ü–ö–û–ô
    await message.answer(
        "‚úÖ –°–ø–∞—Å–∏–±–æ! –ú—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –≤ —Ç–µ—á–µ–Ω–∏–µ 15 –º–∏–Ω—É—Ç.",
        reply_markup=main_menu_button_kb()
    )

    # –ü–ª–∞–Ω–∏—Ä—É–µ–º –∞–≤—Ç–æ—Å–æ–æ–±—â–µ–Ω–∏—è —á–µ—Ä–µ–∑ context
    await context.auto_message_scheduler.schedule_auto_messages(message.from_user.id)

    await state.clear()


================================================================================
–§–ê–ô–õ: handlers\__init__.py
–†–ê–ó–ú–ï–†: 0 –±–∞–π—Ç
================================================================================




================================================================================
–§–ê–ô–õ: keyboards\inline.py
–†–ê–ó–ú–ï–†: 2604 –±–∞–π—Ç
================================================================================

from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton
from aiogram.utils.keyboard import InlineKeyboardBuilder

# –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
def main_menu_kb():
    keyboard = InlineKeyboardBuilder()
    keyboard.add(
        InlineKeyboardButton(text="üéì –ü–æ–º–æ—â—å —Å—Ç—É–¥–µ–Ω—Ç–∞–º", callback_data="student_help"),
        InlineKeyboardButton(text="üíª –û–±—É—á–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—é", callback_data="programming_help")
    )
    return keyboard.adjust(1).as_markup()

# –ú–µ–Ω—é –ø–æ–º–æ—â–∏ —Å—Ç—É–¥–µ–Ω—Ç–∞–º
def student_help_kb():
    keyboard = InlineKeyboardBuilder()
    keyboard.add(
        InlineKeyboardButton(text="üìù –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω—ã–µ", callback_data="work_labs"),
        InlineKeyboardButton(text="üìä –ö—É—Ä—Å–æ–≤—ã–µ", callback_data="work_coursework"),
        InlineKeyboardButton(text="üéì –î–∏–ø–ª–æ–º–Ω—ã–µ", callback_data="work_diploma"),
        InlineKeyboardButton(text="‚ùî –î—Ä—É–≥–æ–µ", callback_data="work_other"),
        InlineKeyboardButton(text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="main_menu")
    )
    return keyboard.adjust(1).as_markup()

# –ú–µ–Ω—é –≤—ã–±–æ—Ä–∞ —è–∑—ã–∫–∞
def language_kb():
    keyboard = InlineKeyboardBuilder()
    keyboard.add(
        InlineKeyboardButton(text="C++", callback_data="lang_cpp"),
        InlineKeyboardButton(text="Python", callback_data="lang_python"),
        InlineKeyboardButton(text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="main_menu")
    )
    return keyboard.adjust(2, 1).as_markup()

# –ú–µ–Ω—é —Ñ–æ—Ä–º–∞—Ç–∞ –æ–±—É—á–µ–Ω–∏—è
def format_kb():
    keyboard = InlineKeyboardBuilder()
    keyboard.add(
        InlineKeyboardButton(text="üë§ –û–Ω–ª–∞–π–Ω –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ", callback_data="format_individual"),
        InlineKeyboardButton(text="üë• –û–Ω–ª–∞–π–Ω –≤ –≥—Ä—É–ø–ø–µ", callback_data="format_group"),
        InlineKeyboardButton(text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="programming_help")
    )
    return keyboard.adjust(1).as_markup()

# –ö–Ω–æ–ø–∫–∞ —Ç–æ–ª—å–∫–æ "–ù–∞–∑–∞–¥"
def back_kb(target: str = "main_menu"):
    keyboard = InlineKeyboardBuilder()
    keyboard.add(InlineKeyboardButton(text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data=target))
    return keyboard.as_markup()

# –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Å –∫–Ω–æ–ø–∫–æ–π –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
def main_menu_button_kb():
    keyboard = InlineKeyboardBuilder()
    keyboard.add(
        InlineKeyboardButton(text="üè† –í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="main_menu")
    )
    return keyboard.as_markup()


================================================================================
–§–ê–ô–õ: keyboards\__init__.py
–†–ê–ó–ú–ï–†: 0 –±–∞–π—Ç
================================================================================




================================================================================
–§–ê–ô–õ: utils\auto_messages.py
–†–ê–ó–ú–ï–†: 4613 –±–∞–π—Ç
================================================================================

# utils/auto_messages.py
import asyncio
import logging
from typing import Dict, List

auto_message_logger = logging.getLogger('app')


class AutoMessageScheduler:
    def __init__(self, bot=None):
        self.bot = bot
        self.scheduled_tasks: Dict[int, List[asyncio.Task]] = {}
        self.vk_scheduled_tasks: Dict[int, List[asyncio.Task]] = {}
        auto_message_logger.info("AutoMessageScheduler –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")

    def set_bot(self, bot):
        """–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–æ—Ç–∞ –ø–æ—Å–ª–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏"""
        self.bot = bot
        auto_message_logger.info("–ë–æ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ AutoMessageScheduler")

    async def schedule_auto_messages(self, user_id: int):
        """–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–≤—Ç–æ—Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è Telegram"""
        if self.bot is None:
            auto_message_logger.error("–ë–æ—Ç –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ AutoMessageScheduler")
            return

        messages = [
            (86400, "üî• –ü–æ–ª–µ–∑–Ω–æ –∑–Ω–∞—Ç—å: 5 —Ç–∏–ø–∏—á–Ω—ã—Ö –æ—à–∏–±–æ–∫ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –ø—Ä–∏ –Ω–∞–ø–∏—Å–∞–Ω–∏–∏ –∫–æ–¥–∞."),  # 1 –¥–µ–Ω—å
            (172800, "üì¢ –û—Ç–∑—ã–≤: 'Lab&Code –ø–æ–º–æ–≥ –º–Ω–µ –∑–∞—â–∏—Ç–∏—Ç—å –¥–∏–ø–ª–æ–º –ø–æ Python!'"),  # 2 –¥–Ω—è
            (259200, "‚è≥ –û—Å—Ç–∞–ª–æ—Å—å 3 –º–µ—Å—Ç–∞ –Ω–∞ —Å–µ–Ω—Ç—è–±—Ä—å—Å–∫–∏–π –∫—É—Ä—Å Python. –£—Å–ø–µ–π –∑–∞–ø–∏—Å–∞—Ç—å—Å—è!")  # 3 –¥–Ω—è
        ]

        for delay, text in messages:
            task = asyncio.create_task(
                self.send_auto_message(user_id, text, delay)
            )
            if user_id not in self.scheduled_tasks:
                self.scheduled_tasks[user_id] = []
            self.scheduled_tasks[user_id].append(task)

        auto_message_logger.info(f"–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ {len(messages)} –∞–≤—Ç–æ—Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")

    async def schedule_vk_messages(self, user_id: int, vk_bot):
        """–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–≤—Ç–æ—Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è VK"""
        messages = [
            (86400, "üî• –ü–æ–ª–µ–∑–Ω–æ –∑–Ω–∞—Ç—å: 5 —Ç–∏–ø–∏—á–Ω—ã—Ö –æ—à–∏–±–æ–∫ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –ø—Ä–∏ –Ω–∞–ø–∏—Å–∞–Ω–∏–∏ –∫–æ–¥–∞."),  # 1 –¥–µ–Ω—å
            (172800, "üì¢ –û—Ç–∑—ã–≤: 'Lab&Code –ø–æ–º–æ–≥ –º–Ω–µ –∑–∞—â–∏—Ç–∏—Ç—å –¥–∏–ø–ª–æ–º –ø–æ Python!'"),  # 2 –¥–Ω—è
            (259200, "‚è≥ –û—Å—Ç–∞–ª–æ—Å—å 3 –º–µ—Å—Ç–∞ –Ω–∞ —Å–µ–Ω—Ç—è–±—Ä—å—Å–∫–∏–π –∫—É—Ä—Å Python. –£—Å–ø–µ–π –∑–∞–ø–∏—Å–∞—Ç—å—Å—è!")  # 3 –¥–Ω—è
        ]

        for delay, text in messages:
            task = asyncio.create_task(
                self.send_vk_auto_message(user_id, text, delay, vk_bot)
            )
            if user_id not in self.vk_scheduled_tasks:
                self.vk_scheduled_tasks[user_id] = []
            self.vk_scheduled_tasks[user_id].append(task)

        auto_message_logger.info(f"–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ {len(messages)} VK –∞–≤—Ç–æ—Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")

    async def send_auto_message(self, user_id: int, message: str, delay: int):
        """–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Telegram"""
        try:
            await asyncio.sleep(delay)
            await self.bot.send_message(user_id, message)
            auto_message_logger.info(f"–ê–≤—Ç–æ—Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}")
        except Exception as e:
            auto_message_logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∞–≤—Ç–æ—Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}: {e}")

    async def send_vk_auto_message(self, user_id: int, message: str, delay: int, vk_bot):
        """–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ VK"""
        try:
            await asyncio.sleep(delay)
            vk_bot.send_message(user_id, message)
            auto_message_logger.info(f"VK –∞–≤—Ç–æ—Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}")
        except Exception as e:
            auto_message_logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ VK –∞–≤—Ç–æ—Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}: {e}")

    def cancel_user_tasks(self, user_id: int):
        """–û—Ç–º–µ–Ω–∞ –∑–∞–¥–∞—á –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        if user_id in self.scheduled_tasks:
            for task in self.scheduled_tasks[user_id]:
                task.cancel()
            del self.scheduled_tasks[user_id]
            auto_message_logger.info(f"–ó–∞–¥–∞—á–∏ –æ—Ç–º–µ–Ω–µ–Ω—ã –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")


================================================================================
–§–ê–ô–õ: utils\context.py
–†–ê–ó–ú–ï–†: 438 –±–∞–π—Ç
================================================================================

# utils/context.py
"""–ì–ª–æ–±–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏—Ö –∏–º–ø–æ—Ä—Ç–æ–≤"""

class BotContext:
    def __init__(self):
        self.bot = None
        self.auto_message_scheduler = None

# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä
context = BotContext()

def set_bot(bot):
    context.bot = bot

def set_scheduler(scheduler):
    context.auto_message_scheduler = scheduler


================================================================================
–§–ê–ô–õ: utils\logger.py
–†–ê–ó–ú–ï–†: 1666 –±–∞–π—Ç
================================================================================

# utils/logger.py
import logging
import os
from logging.handlers import TimedRotatingFileHandler
import glob
import tempfile

def setup_logger():
    """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–≥–µ—Ä–∞ —Å –∑–∞–ø–∏—Å—å—é –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é"""

    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
    log_dir = tempfile.gettempdir()

    # –û—Å–Ω–æ–≤–Ω–æ–π —Ñ–æ—Ä–º–∞—Ç—Ç–µ—Ä
    formatter = logging.Formatter(
        '%(asctime)s - %(name)s - %(levelname)s - %(message)s',
        datefmt='%Y-%m-%d %H:%M:%S'
    )

    # –û—Å–Ω–æ–≤–Ω–æ–π –ª–æ–≥–≥–µ—Ä
    logger = logging.getLogger()
    logger.setLevel(logging.INFO)

    # –§–∞–π–ª–æ–≤—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
    log_file = os.path.join(log_dir, 'bot.log')
    file_handler = TimedRotatingFileHandler(
        filename=log_file,
        when='W0',
        interval=1,
        backupCount=4,
        encoding='utf-8'
    )
    file_handler.setFormatter(formatter)
    file_handler.setLevel(logging.INFO)

    # –ö–æ–Ω—Å–æ–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
    console_handler = logging.StreamHandler()
    console_handler.setFormatter(formatter)
    console_handler.setLevel(logging.INFO)

    # –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∏ –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ
    logger.handlers.clear()
    logger.addHandler(file_handler)
    logger.addHandler(console_handler)

    logging.info(f"‚úÖ –õ–æ–≥–≥–µ—Ä –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –õ–æ–≥–∏ –≤: {log_file}")

    return logger

def cleanup_old_logs():
    """–û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –ª–æ–≥-—Ñ–∞–π–ª–æ–≤ (–∑–∞–≥–ª—É—à–∫–∞)"""
    pass


================================================================================
–§–ê–ô–õ: utils\notifications.py
–†–ê–ó–ú–ï–†: 6195 –±–∞–π—Ç
================================================================================

# utils/notifications.py
import logging
from aiogram import Bot
from config import ADMIN_ID, VK_ADMIN_ID, VK_GROUP_TOKEN
import vk_api
from datetime import datetime

notification_logger = logging.getLogger('app')


async def notify_admin(bot: Bot, user_data: dict, contact_info: str):
    """–û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –≤ Telegram"""
    if not ADMIN_ID:
        notification_logger.warning("ADMIN_ID –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ.")
        return

    try:
        timestamp = datetime.now().strftime('%Y-%m-%d %H:%M:%S')

        if user_data.get('category') == 'student_help':
            message_text = f"""
üìã **–ù–û–í–´–ô –ó–ê–ü–†–û–° –û–¢ –°–¢–£–î–ï–ù–¢–ê**

üë§ **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:** @{user_data.get('username', 'N/A')} (ID: {user_data.get('user_id', 'N/A')})
üìù **–¢–∏–ø —Ä–∞–±–æ—Ç—ã:** {user_data.get('work_type', 'N/A')}
üìû **–ö–æ–Ω—Ç–∞–∫—Ç:** {contact_info}
üïê **–í—Ä–µ–º—è:** {timestamp}

‚ö° **–¢—Ä–µ–±—É–µ—Ç –±—ã—Å—Ç—Ä–æ–≥–æ –æ—Ç–≤–µ—Ç–∞!**
            """
        else:
            message_text = f"""
üìã **–ù–û–í–´–ô –ó–ê–ü–†–û–° –ù–ê –û–ë–£–ß–ï–ù–ò–ï**

üë§ **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:** @{user_data.get('username', 'N/A')} (ID: {user_data.get('user_id', 'N/A')})
üíª **–Ø–∑—ã–∫:** {user_data.get('language', 'N/A')}
üìö **–§–æ—Ä–º–∞—Ç:** {user_data.get('format', 'N/A')}
üìû **–ö–æ–Ω—Ç–∞–∫—Ç:** {contact_info}
üïê **–í—Ä–µ–º—è:** {timestamp}

‚ö° **–¢—Ä–µ–±—É–µ—Ç –±—ã—Å—Ç—Ä–æ–≥–æ –æ—Ç–≤–µ—Ç–∞!**
            """

        await bot.send_message(
            chat_id=ADMIN_ID,
            text=message_text,
            parse_mode='Markdown'
        )
        notification_logger.info(f"–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –∞–¥–º–∏–Ω—É {ADMIN_ID} –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_data.get('user_id')}")

    except Exception as e:
        notification_logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω—É: {e}")


def notify_admin_vk(user_data: dict, contact_info: str, user_id: int):
    """–û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –≤ VK"""
    if not VK_ADMIN_ID or not VK_GROUP_TOKEN:
        notification_logger.warning("VK_ADMIN_ID –∏–ª–∏ VK_GROUP_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ.")
        return

    try:
        # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é —Å–µ—Å—Å–∏—é VK –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        vk_session = vk_api.VkApi(token=VK_GROUP_TOKEN)
        vk = vk_session.get_api()

        timestamp = datetime.now().strftime('%Y-%m-%d %H:%M:%S')

        if user_data.get('category') == 'student_help':
            message_text = f"""
üìã –ù–û–í–´–ô –ó–ê–ü–†–û–° –û–¢ –°–¢–£–î–ï–ù–¢–ê (VK)

üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: VK ID: {user_id}
üìù –¢–∏–ø —Ä–∞–±–æ—Ç—ã: {user_data.get('work_type', 'N/A')}
üìû –ö–æ–Ω—Ç–∞–∫—Ç: {contact_info}
üïê –í—Ä–µ–º—è: {timestamp}

‚ö° –¢—Ä–µ–±—É–µ—Ç –±—ã—Å—Ç—Ä–æ–≥–æ –æ—Ç–≤–µ—Ç–∞!
            """
        else:
            message_text = f"""
üìã –ù–û–í–´–ô –ó–ê–ü–†–û–° –ù–ê –û–ë–£–ß–ï–ù–ò–ï (VK)

üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: VK ID: {user_id}
üíª –Ø–∑—ã–∫: {user_data.get('language', 'N/A')}
üìö –§–æ—Ä–º–∞—Ç: {user_data.get('format', 'N/A')}
üìû –ö–æ–Ω—Ç–∞–∫—Ç: {contact_info}
üïê –í—Ä–µ–º—è: {timestamp}

‚ö° –¢—Ä–µ–±—É–µ—Ç –±—ã—Å—Ç—Ä–æ–≥–æ –æ—Ç–≤–µ—Ç–∞!
            """

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É VK
        vk.messages.send(
            user_id=int(VK_ADMIN_ID),
            message=message_text,
            random_id=vk_api.utils.get_random_id()
        )

        notification_logger.info(f"VK —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –∞–¥–º–∏–Ω—É {VK_ADMIN_ID} –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")

    except vk_api.exceptions.ApiError as e:
        notification_logger.error(f"VK API –æ—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω—É: {e}")
    except Exception as e:
        notification_logger.error(f"–û–±—â–∞—è –æ—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ VK —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω—É: {e}")


# –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é VK —Å–µ—Å—Å–∏—é
def notify_admin_vk_with_session(vk_api_object, user_data: dict, contact_info: str, user_id: int):
    """–û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –≤ VK —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ VK API –æ–±—ä–µ–∫—Ç–∞"""
    if not VK_ADMIN_ID:
        notification_logger.warning("VK_ADMIN_ID –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ.")
        return

    try:
        timestamp = datetime.now().strftime('%Y-%m-%d %H:%M:%S')

        if user_data.get('category') == 'student_help':
            message_text = f"""
üìã –ù–û–í–´–ô –ó–ê–ü–†–û–° –û–¢ –°–¢–£–î–ï–ù–¢–ê (VK)

üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: VK ID: {user_id}
üìù –¢–∏–ø —Ä–∞–±–æ—Ç—ã: {user_data.get('work_type', 'N/A')}
üìû –ö–æ–Ω—Ç–∞–∫—Ç: {contact_info}
üïê –í—Ä–µ–º—è: {timestamp}

‚ö° –¢—Ä–µ–±—É–µ—Ç –±—ã—Å—Ç—Ä–æ–≥–æ –æ—Ç–≤–µ—Ç–∞!
            """
        else:
            message_text = f"""
üìã –ù–û–í–´–ô –ó–ê–ü–†–û–° –ù–ê –û–ë–£–ß–ï–ù–ò–ï (VK)

üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: VK ID: {user_id}
üíª –Ø–∑—ã–∫: {user_data.get('language', 'N/A')}
üìö –§–æ—Ä–º–∞—Ç: {user_data.get('format', 'N/A')}
üìû –ö–æ–Ω—Ç–∞–∫—Ç: {contact_info}
üïê –í—Ä–µ–º—è: {timestamp}

‚ö° –¢—Ä–µ–±—É–µ—Ç –±—ã—Å—Ç—Ä–æ–≥–æ –æ—Ç–≤–µ—Ç–∞!
            """

        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–π VK API –æ–±—ä–µ–∫—Ç
        vk_api_object.messages.send(
            user_id=int(VK_ADMIN_ID),
            message=message_text,
            random_id=vk_api.utils.get_random_id()
        )

        notification_logger.info(f"VK —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –∞–¥–º–∏–Ω—É {VK_ADMIN_ID} –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")

    except Exception as e:
        notification_logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ VK —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω—É: {e}")


====================================================================================================
–°–¢–ê–¢–ò–°–¢–ò–ö–ê:
- –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ —Ñ–∞–π–ª–æ–≤: 19
- –û–±—â–∏–π —Ä–∞–∑–º–µ—Ä –∫–æ–¥–∞: 55967 –±–∞–π—Ç
- –î–∞—Ç–∞ —Å–±–æ—Ä–∫–∏: 2025-11-06 12:11:57
